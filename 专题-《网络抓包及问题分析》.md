# linux 网络抓包

## linux tcpdump

在 Linux 系统中，`tcpdump`是一个强大的网络数据包分析工具。以下是关于它的详细介绍：

一、功能特点

1. 强大的数据包捕获能力
   - 可以捕获各种网络协议的数据包，包括 TCP、UDP、ICMP、IP 等。
   - 能够从指定的网络接口捕获数据包，也可以同时捕获多个接口的数据包。
2. 灵活的过滤功能
   - 通过使用各种过滤表达式，可以只捕获符合特定条件的数据包。例如，可以根据源 IP 地址、目的 IP 地址、端口号、协议类型等条件进行过滤。
3. 支持多种输出格式
   - 可以将捕获的数据包以文本形式输出到终端，也可以保存为二进制文件以便后续分析。
   - 支持多种数据包解析格式，如人类可读的格式、十六进制格式等。

二、安装方法

在大多数 Linux 发行版中，`tcpdump`通常可以通过包管理工具进行安装。例如：

1. 在 Ubuntu 或 Debian 系统中，可以使用以下命令安装：

```plaintext
sudo apt-get install tcpdump
```

1. 在 CentOS 或 Red Hat 系统中，可以使用以下命令安装：

```plaintext
sudo yum install tcpdump
```

三、使用方法

1. 基本用法
   - 直接在终端中输入`tcpdump`命令，它将开始捕获网络接口上的数据包，并将其输出到终端。例如：

```plaintext
sudo tcpdump
```

- 可以使用 `-i`参数指定要捕获数据包的网络接口。例如，要捕获`eth0`接口上的数据包，可以使用以下命令：

```plaintext
sudo tcpdump -i eth0
```

1. 过滤数据包
   - 使用各种过滤表达式来只捕获符合特定条件的数据包。例如，要捕获特定 IP 地址的数据包，可以使用以下命令：

```plaintext
sudo tcpdump host 192.168.1.100
```

- 可以根据协议类型进行过滤。例如，要捕获 TCP 协议的数据包，可以使用以下命令：

```plaintext
sudo tcpdump tcp
```

- 可以根据端口号进行过滤。例如，要捕获特定端口的数据包，可以使用以下命令：

```plaintext
sudo tcpdump port 80
```

1. 保存抓包结果
   - 可以使用 `-w`参数将捕获的数据包保存到文件中。例如：

```plaintext
sudo tcpdump -i eth0 -w capture.pcap
```

- 保存的文件可以使用网络数据包分析工具如 Wireshark 进行后续分析。

四、注意事项

1. 需要管理员权限
   - 由于需要访问网络接口，通常需要以管理员身份运行`tcpdump`，即使用`sudo`命令。
2. 理解过滤表达式
   - 正确使用过滤表达式是关键，需要熟悉各种网络协议的字段和语法，以便准确地捕获所需的数据包。
3. 注意性能影响
   - 在高流量的网络环境中，捕获数据包可能会对系统性能产生一定的影响。如果不需要实时分析，可以将数据包保存到文件中，然后在离线状态下进行分析。

# linux 问题分析

## linux arp

在 Linux 系统中，ARP（Address Resolution Protocol，地址解析协议）主要用于将 IP 地址解析为 MAC 地址。

### 一、ARP 的作用

在网络通信中，设备需要知道目标 IP 地址对应的 MAC 地址才能进行数据传输。当一个设备知道目标设备的 IP 地址但不知道其 MAC 地址时，它会发送一个 ARP 请求广播包到网络中。所有收到这个广播包的设备都会检查自己的 IP 地址是否与请求中的目标 IP 地址一致。如果一致，该设备就会回复一个 ARP 应答包，其中包含自己的 MAC 地址。这样，请求设备就可以获得目标设备的 MAC 地址，并将其用于后续的数据通信。

### 二、查看 ARP 缓存

可以使用以下命令查看 Linux 系统中的 ARP 缓存：

```
arp -a
```

该命令会列出当前系统缓存中的 IP 地址和对应的 MAC 地址信息。

### 三、手动添加 ARP 条目

如果需要手动添加一个 ARP 条目，可以使用以下命令：

```
arp -s IP地址 MAC地址
```

例如：`arp -s 192.168.1.100 00:11:22:33:44:55`

这将把 IP 地址为 192.168.1.100 的设备的 MAC 地址设置为 00:11:22:33:44:55，并添加到 ARP 缓存中。

### 四、删除 ARP 条目

要删除一个特定的 ARP 条目，可以使用以下命令：

```
arp -d IP地址
```

例如：`arp -d 192.168.1.100`

这将从 ARP 缓存中删除 IP 地址为 192.168.1.100 的条目。

### 五、ARP 相关的配置文件

在一些 Linux 发行版中，可能会有与 ARP 相关的配置文件，例如 `/etc/sysctl.conf`。可以通过修改这个文件中的参数来调整系统的 ARP 行为，比如设置 ARP 缓存的超时时间等。

总的来说，了解和掌握 Linux 中的 ARP 命令和相关配置对于网络管理和故障排除非常有帮助。

## linux routing table

在 Linux 系统中，路由表用于确定网络数据包的传输路径。以下是关于 Linux 路由表的详细介绍：

### 一、路由表的作用

路由表就像是网络世界中的交通地图，它决定了数据包从源地址到目的地址应该走哪条路径。当一个数据包到达 Linux 系统时，系统会根据路由表中的信息来选择合适的网络接口将数据包发送出去。如果没有正确的路由信息，数据包可能无法到达目的地。

### 二、路由表的组成

1. 目的网络地址和子网掩码
   - 这两个字段共同确定了数据包的目的地址范围。例如，如果目的地址是 192.168.1.10，子网掩码是 255.255.255.0，那么路由表中的目的网络地址可能是 192.168.1.0/24，表示任何目的地址在这个子网范围内的数据包都适用这条路由。
2. 网关地址
   - 如果数据包的目的地址不在本地网络中，就需要将数据包发送到网关地址，由网关负责将数据包转发到下一跳。网关可以是本地网络中的路由器或者其他具有路由功能的设备。
3. 网络接口
   - 确定数据包将从哪个网络接口发送出去。例如，可能是以太网接口、无线接口等。

### 三、查看路由表

可以使用 “route” 或 “ip route show” 命令来查看 Linux 系统的路由表。例如：

```plaintext
$ route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    0      0        0 eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
```

或者：

```plaintext
$ ip route show
default via 192.168.1.1 dev eth0
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100
```

### 四、添加和删除路由

1. 添加路由
   - 使用 “ip route add” 命令可以添加一条新的路由。例如，“ip route add 10.0.0.0/8 via 192.168.1.2 dev eth1” 表示将目的地址为 10.0.0.0/8 的数据包通过网关 192.168.1.2 并从网络接口 eth1 发送出去。
2. 删除路由
   - 使用 “ip route del” 命令可以删除一条路由。例如，“ip route del 10.0.0.0/8” 可以删除上述添加的路由。

### 五、路由优先级

当有多条路由可以到达同一个目的地址时，Linux 系统会根据路由的优先级来选择使用哪条路由。一般来说，具有更具体目的网络地址的路由优先级更高。例如，一条目的地址为 192.168.1.10 的路由比目的地址为 192.168.0.0/16 的路由更具体，所以优先级更高。

## linux ping

在 Linux 系统中，`ping`命令用于测试网络连接的可达性。

### 一、基本用法

1. 测试与特定 IP 地址的连接：

```plaintext
ping IP地址
```

例如：`ping 8.8.8.8`，会向 IP 地址为 8.8.8.8 的目标发送 ICMP（Internet Control Message Protocol，互联网控制报文协议）回显请求数据包，并显示响应情况。

1. 测试与特定域名的连接：

```plaintext
ping 域名
```

例如：`ping www.example.com`，会先将域名解析为 IP 地址，然后进行连接测试。

### 二、常用参数

1. `-c`：指定发送的 ICMP 数据包数量。
   例如：`ping -c 5 8.8.8.8`，表示发送 5 个数据包后停止。
2. `-i`：设置发送数据包的时间间隔。
   例如：`ping -i 0.5 8.8.8.8`，表示每隔 0.5 秒发送一个数据包。
3. `-s`：设置数据包的大小。
   例如：`ping -s 1000 8.8.8.8`，设置数据包大小为 1000 字节。

### 三、输出解释

1. `PING 目标地址 (目标 IP 地址)`：显示正在测试的目标。
2. `(目标 IP 地址) 的统计信息`：包括发送的数据包数量、接收的数据包数量、丢失的数据包数量以及往返时间的统计信息。
3. `rtt min/avg/max/mdev`：分别表示往返时间的最小值、平均值、最大值和平均偏差。

### 四、应用场景

1. 网络故障排除：当网络连接出现问题时，可以使用`ping`命令测试不同的目标地址，以确定问题是出在本地网络、中间网络还是目标服务器。
2. 网络性能测试：通过观察`ping`命令的输出，可以了解网络的延迟和稳定性，评估网络性能。

## linux traceroute

在 Linux 系统中，`traceroute`命令用于追踪数据包从本地主机到目标主机所经过的路由路径。

### 一、基本用法

```plaintext
traceroute 目标地址
```

例如：`traceroute www.example.com`，会显示数据包从本地主机到达目标域名所经过的各个 IP 地址和响应时间。

### 二、常用参数

1. `-n`：不进行域名解析，直接显示 IP 地址。这样可以加快追踪速度，尤其是当域名解析较慢时。
   例如：`traceroute -n 8.8.8.8`。
2. `-m`：设置最大跳数（TTL，Time To Live）。默认情况下，`traceroute`会逐步增加 TTL 值，直到到达目标或超过最大跳数。可以使用这个参数指定一个较小的最大跳数来快速测试。
   例如：`traceroute -m 10 8.8.8.8`。
3. `-p`：指定目标主机的端口号。默认情况下，`traceroute`使用 UDP 端口 33434 进行探测。可以使用这个参数指定其他端口号。
   例如：`traceroute -p 80 8.8.8.8`，表示对目标主机的 80 端口进行追踪。

### 三、输出解释

1. 每一行代表一跳，显示经过的 IP 地址、主机名（如果进行了域名解析）和响应时间。
2. 当数据包到达某一跳时，如果超时未收到响应，会显示星号（*）。
3. 最后一跳通常是目标主机，显示目标主机的 IP 地址和名称。

### 四、应用场景

1. 网络故障排除：当网络连接出现问题时，可以使用`traceroute`命令确定数据包在哪个节点出现了延迟或丢失。这有助于定位网络故障的位置，例如路由器故障、网络拥塞等。
2. 网络性能评估：通过观察`traceroute`的输出，可以了解数据包在不同节点的响应时间，评估网络的性能和稳定性。
3. 网络拓扑了解：`traceroute`可以帮助你了解网络的拓扑结构，包括中间经过的路由器和服务器。

## linux netstat

在 Linux 系统中，`netstat`命令用于显示各种网络相关信息。

### 一、主要功能

1. 显示网络连接状态
   - 可以列出当前系统中所有的 TCP 和 UDP 连接，包括本地地址、外部地址、连接状态等信息。例如，你可以查看哪些程序正在与外部服务器建立连接，以及连接的状态是已建立（ESTABLISHED）、监听（LISTEN）还是其他状态。
   - `netstat -t`：仅显示 TCP 连接。
   - `netstat -u`：仅显示 UDP 连接。
2. 显示网络接口信息
   - 可以显示系统中所有网络接口的状态，包括接口名称、IP 地址、接收和发送的数据包数量等。这对于了解系统的网络配置和流量情况非常有用。
   - `netstat -i`：显示网络接口统计信息。
3. 显示路由表信息
   - 可以列出系统的路由表，包括目标网络、网关、接口等信息。这有助于了解数据包如何在网络中传输以及如何选择最佳路径。
   - `netstat -r`：显示路由表。
4. 显示监听端口
   - 可以列出当前系统中正在监听的端口，以及对应的程序和协议。这对于查找潜在的安全风险或了解系统中运行的服务非常有帮助。
   - `netstat -l`：显示监听状态的端口。

### 二、常用参数

1. `-n`：以数字形式显示地址和端口号，而不是尝试进行域名解析。这可以加快命令的执行速度，特别是在处理大量连接时。
2. `-p`：显示与每个连接或端口相关的进程 ID 和程序名称。这对于确定哪个程序正在使用特定的端口非常有用。
3. `-a`：显示所有的连接和监听端口，包括处于监听状态但尚未建立连接的端口。

### 三、应用场景

1. 网络故障排除：当网络连接出现问题时，可以使用`netstat`命令检查连接状态、监听端口等信息，以确定问题的根源。例如，如果某个程序无法连接到外部服务器，可以使用`netstat`查看是否有相应的连接尝试，以及连接状态是否正常。
2. 安全审计：通过查看监听端口和连接信息，可以发现潜在的安全风险，例如未经授权的服务正在运行或恶意程序正在建立连接。
3. 性能监控：可以定期使用`netstat`检查网络连接和流量情况，以了解系统的网络负载和性能表现。如果发现某个端口的连接数量异常高，可能需要进一步调查是否存在性能问题或安全隐患。

## linux nslookup

在 Linux 系统中，`nslookup`是一个用于查询 DNS（Domain Name System，域名系统）信息的工具。

### 一、基本用法

1. 查询域名对应的 IP 地址：

```plaintext
nslookup 域名
```

例如：`nslookup www.example.com`，会显示该域名对应的 IP 地址以及相关的 DNS 服务器信息。

1. 查询特定 DNS 服务器上的域名信息：

```plaintext
nslookup 域名 DNS服务器地址
```

例如：`nslookup www.example.com 8.8.8.8`，会使用指定的 DNS 服务器（8.8.8.8 是 Google 的公共 DNS 服务器）查询该域名的信息。

### 二、输出解释

1. 非交互模式下，会显示查询的域名、对应的 IP 地址以及使用的 DNS 服务器信息。

2. 交互模式下，启动

   ```
   nslookup
   ```

   后不输入任何参数，进入交互模式。在交互模式下，可以输入不同的命令来查询 DNS 信息，例如：

   - `server`：切换使用的 DNS 服务器。
   - `set type=`：设置查询的记录类型，如 A（地址记录）、MX（邮件交换记录）、NS（名称服务器记录）等。

### 三、应用场景

1. 网络故障排除：当无法访问某个网站时，可以使用`nslookup`检查域名是否能够正确解析为 IP 地址。如果无法解析，可能是 DNS 配置出现问题或者 DNS 服务器故障。
2. DNS 服务器测试：可以使用不同的 DNS 服务器进行查询，比较它们的响应时间和准确性，以选择最适合的 DNS 服务器。
3. 域名信息查询：通过设置不同的查询记录类型，可以获取域名的各种相关信息，如邮件服务器、名称服务器等。

## linux ip

在 Linux 系统中，`ip`命令是一个强大的网络配置和管理工具，它可以替代一些传统的网络命令，如`ifconfig`等。以下是关于`ip`命令的详细介绍：

### 一、基本功能

1. 地址管理
   - 查看和配置网络接口的 IP 地址、子网掩码等信息。
   - 例如，“ip addr show” 可以显示系统中所有网络接口的 IP 地址和状态。
   - “ip addr add 192.168.1.100/24 dev eth0” 可以为以太网接口`eth0`添加一个 IP 地址为 192.168.1.100，子网掩码为 255.255.255.0 的地址。
2. 路由管理
   - 查看和配置系统的 IP 路由表。
   - “ip route show” 可以显示当前的路由表，“ip route add 10.0.0.0/8 via 192.168.1.2 dev eth1” 可以添加一条路由，将目的地址为 10.0.0.0/8 的数据包通过网关 192.168.1.2 并从网络接口`eth1`发送出去。
3. 网络接口管理
   - 启用、禁用网络接口。
   - “ip link set eth0 up” 可以启用以太网接口`eth0`，“ip link set eth0 down” 可以禁用该接口。

### 二、高级功能

1. 邻居发现
   - 查看和管理网络中的邻居设备，即与本地系统直接通信的其他设备的 IP 地址和 MAC 地址对应关系。
   - “ip neigh show” 可以显示邻居表。
2. 隧道配置
   - 可以创建和管理 IP 隧道，用于在不同网络之间建立虚拟连接。
3. 多播管理
   - 配置和管理多播组，用于实现一对多的通信。

### 三、使用示例

1. 查看网络接口状态：

```plaintext
$ ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
link/ether 00:11:22:33:44:55 brd ff:ff:ff:ff:ff:ff
```

1. 添加 IP 地址：

```plaintext
$ ip addr add 192.168.1.101/24 dev eth0
```

1. 查看路由表：

```plaintext
$ ip route show
default via 192.168.1.1 dev eth0
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100
```

## linux iptable

在 Linux 系统中，iptables 是一种常用的防火墙工具，用于配置网络数据包的过滤规则。

### 一、主要功能

1. 数据包过滤
   - 可以根据数据包的源 IP 地址、目的 IP 地址、协议类型（如 TCP、UDP、ICMP 等）、端口号等信息来决定是否允许数据包通过。
   - 例如，可以设置只允许特定 IP 地址的主机访问某个服务端口，或者阻止来自特定 IP 段的恶意流量。
2. 网络地址转换（NAT）
   - 包括源地址转换（SNAT）和目的地址转换（DNAT）。
   - SNAT 通常用于让内网中的多台主机共享一个公网 IP 地址上网，它会将内网主机发出的数据包的源 IP 地址替换为路由器的公网 IP 地址。
   - DNAT 则用于将外部网络对特定公网 IP 和端口的访问转发到内网中的特定服务器上，实现端口映射。
3. 数据包修改
   - 可以对数据包的一些字段进行修改，如 TTL（生存时间）值等。

### 二、基本概念

1. 链（Chain）
   - iptables 中有多个不同的链，每个链都有特定的用途。
   - 常见的链有 INPUT（处理进入本机的数据包）、OUTPUT（处理本机发出的数据包）、FORWARD（处理转发的数据包）等。
2. 规则（Rule）
   - 规则是定义在链上的具体过滤条件和动作。
   - 一条规则通常由匹配条件和目标动作组成。匹配条件确定哪些数据包会被这条规则处理，目标动作则决定对匹配的数据包采取什么操作，如 ACCEPT（允许通过）、DROP（丢弃）、REJECT（拒绝并返回错误信息）等。

### 三、使用方法

1. 查看规则
   - 使用 “iptables -L” 命令可以查看当前系统中所有链上的规则。
   - 可以添加参数来查看特定链的规则，如 “iptables -L INPUT”。

```bash
Chain INPUT (policy DROP)
target     prot opt source               destination
ufw-before-logging-input  all  --  anywhere             anywhere
ufw-before-input  all  --  anywhere             anywhere
ufw-after-input  all  --  anywhere             anywhere
ufw-after-logging-input  all  --  anywhere             anywhere
ufw-reject-input  all  --  anywhere             anywhere
ufw-track-input  all  --  anywhere             anywhere
```

1. 添加规则
   - “iptables -A [链名] [匹配条件] -j [目标动作]” 用于添加一条规则到指定的链上。
   - 例如，“iptables -A INPUT -s 192.168.1.100 -p tcp --dport 80 -j ACCEPT” 表示允许来自 IP 地址为 192.168.1.100 的主机对本机 80 端口的 TCP 连接。
2. 删除规则
   - “iptables -D [链名] [规则编号]” 可以删除指定链上的一条规则。
   - 规则编号可以通过查看规则时显示的序号确定。
3. 保存规则
   - 一般情况下，系统重启后 iptables 规则会丢失。可以使用工具如 “iptables-save” 和 “iptables-restore” 来保存和恢复规则。

